# API Key Guide for BGE-M3 Service

## Understanding API Keys in Your BGE-M3 Service

Unlike many cloud services where API keys are generated by the platform, in this setup **you define your own API keys**. These keys are simply strings that you choose and configure as environment variables when deploying the service.

## How API Keys Work in This System

1. **You Define the Keys**: You decide what strings to use as API keys (e.g., "my-secret-key-123")

2. **Keys Are Set During Deployment**: The keys are passed as environment variables to your container using the `ALLOWED_API_KEYS` variable in the deployment script

3. **API Validates Incoming Requests**: The Flask app checks if incoming requests contain one of these predefined keys

4. **No External Key Management**: This is a simple form of authentication that doesn't use Google's API Gateway or Key Management services

## Configuring API Keys

### In the Deployment Script

In your `gcp_deploy.sh` script, you'll see:

```bash
--set-env-vars="ALLOWED_API_KEYS=$API_KEY_1,$API_KEY_2,$API_KEY_3"
```

Replace `$API_KEY_1`, `$API_KEY_2`, and `$API_KEY_3` with your custom strings, or define these variables earlier in the script.

### In Google Cloud Console

You can also add or modify API keys after deployment:

1. Go to Google Cloud Console → Cloud Run → Select your service (bge-m3-api)
2. Click "Edit and Deploy New Revision"
3. Under "Variables & Secrets", find or add the `ALLOWED_API_KEYS` variable
4. Set its value to a comma-separated list of your desired API keys
5. Click "Deploy" to update

## Using API Keys in Requests

To make an authenticated request to your API, include the API key in an HTTP header:

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key-here" \
  -d '{"texts": ["This is a test."]}' \
  https://your-service-url/encode
```

In Python:

```python
import requests

headers = {
    "Content-Type": "application/json",
    "X-API-Key": "your-api-key-here"
}

response = requests.post(
    "https://your-service-url/encode",
    headers=headers,
    json={"texts": ["This is a test."]}
)
```

## API Key Security Best Practices

1. **Use Strong Keys**: Generate complex, random strings
2. **Rotate Keys Regularly**: Update your keys periodically
3. **Limit Key Distribution**: Only share keys with authorized users
4. **Use Environment Variables**: Never hardcode keys in client applications
5. **Consider Advanced Security**: For production systems, consider using Google Cloud API Gateway with proper API key management

## How the API Validates Keys

The Flask application validates API keys using middleware that checks the "X-API-Key" header against the list of allowed keys. This code is in the `app.py` file:

```python
# This is a simplified example of how key validation works
@app.route('/encode', methods=['POST'])
@require_api_key  # This decorator checks for a valid API key
def encode_texts():
    # Process the request
    pass

def require_api_key(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        api_key = request.headers.get('X-API-Key')
        if api_key not in ALLOWED_API_KEYS:
            return jsonify({"error": "Invalid or missing API key"}), 401
        return f(*args, **kwargs)
    return decorated_function
```
